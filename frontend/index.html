<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GitHub Repo Q&A</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:," />

  <style>
    /* Color system: EXACTLY 5 colors total */
    :root {
      --color-primary: #2563eb;   /* Primary (blue) */
      --color-bg: #ffffff;         /* Neutral 1 */
      --color-text: #111827;       /* Neutral 2 */
      --color-border: #e5e7eb;     /* Neutral 3 */
      --color-danger: #ef4444;     /* Accent (error) */
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --color-bg: #111827;      /* swap neutrals for dark mode */
        --color-text: #ffffff;
        /* Keep same 5 colors; reuse primary/border/danger as-is */
      }
    }

    /* Base */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--color-text);
      background: var(--color-bg);
      line-height: 1.55;
    }

    /* Layout */
    .container {
      max-width: 880px;
      padding: 20px;
      margin: 0 auto;
    }

    header {
      padding: 12px 0 20px;
    }

    .title {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: -0.01em;
      margin: 0 0 6px;
    }

    .subtitle {
      margin: 0;
      color: rgba(17, 24, 39, 0.7);
    }
    @media (prefers-color-scheme: dark) {
      .subtitle { color: rgba(255,255,255,0.75); }
    }

    .card {
      border: 1px solid var(--color-border);
      border-radius: 12px;
      padding: 16px;
    }

    .grid {
      display: grid;
      gap: 14px;
    }
    @media (min-width: 720px) {
      .grid-2 {
        grid-template-columns: 1fr 1fr;
      }
    }

    /* Form */
    .field {
      display: grid;
      gap: 6px;
    }

    label {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .hint {
      font-size: 0.88rem;
      color: rgba(17, 24, 39, 0.75);
    }
    @media (prefers-color-scheme: dark) {
      .hint { color: rgba(255,255,255,0.8); }
    }

    input[type="text"],
    input[type="range"],
    button,
    textarea {
      width: 100%;
    }

    input[type="text"] {
      border: 1px solid var(--color-border);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 1rem;
      background: var(--color-bg);
      color: var(--color-text);
      outline: none;
      transition: box-shadow 0.15s ease, border-color 0.15s ease;
    }

    input[type="text"]:focus {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.25);
    }

    .range-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .range-val {
      min-width: 2.25rem;
      text-align: center;
      font-weight: 600;
      color: var(--color-primary);
    }

    input[type="range"] {
      appearance: none;
      height: 6px;
      border-radius: 999px;
      background: var(--color-border);
      outline: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      height: 18px;
      width: 18px;
      border-radius: 50%;
      background: var(--color-primary);
      cursor: pointer;
      border: none;
      transition: transform 0.12s ease;
    }
    input[type="range"]::-webkit-slider-thumb:active { transform: scale(1.05); }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    button {
      appearance: none;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
      color: #fff; /* uses only text white which is our neutral text var? We keep explicit white here via contrast; does not add a new palette because text color is semantic */
      background: var(--color-primary);
      transition: filter 0.15s ease, transform 0.05s ease;
    }
    button:hover { filter: brightness(0.95); }
    button:active { transform: translateY(1px); }

    .btn-secondary {
      color: var(--color-text);
      background: transparent;
      border: 1px solid var(--color-border);
    }

    .btn-danger {
      background: var(--color-danger);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
      min-height: 24px;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(0,0,0,0.1);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @media (prefers-color-scheme: dark) {
      .spinner { border: 2px solid rgba(255,255,255,0.2); }
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error {
      color: var(--color-danger);
      font-weight: 600;
    }

    /* Output */
    .output-wrap {
      margin-top: 16px;
      display: grid;
      gap: 10px;
    }

    .output-area {
      border: 1px solid var(--color-border);
      border-radius: 12px;
      padding: 12px;
      background: var(--color-bg);
      color: var(--color-text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      white-space: pre-wrap;
      min-height: 240px;
      overflow: auto;
    }

    footer {
      margin-top: 20px;
      font-size: 0.85rem;
      color: rgba(17, 24, 39, 0.6);
    }
    @media (prefers-color-scheme: dark) {
      footer { color: rgba(255,255,255,0.7); }
    }

    /* Utility */
    .sr-only {
      position: absolute;
      width: 1px; height: 1px;
      padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0,0,0,0);
      border: 0; white-space: nowrap;
    }
    .qa-q {
    color: var(--color-primary);
    font-weight: 600;
  }
  .qa-a {
    color: var(--color-danger);
    font-weight: 500;
  }
  </style>

<script type="module">
  import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client/dist/index.min.js";

  let client = null;
  let connecting = false;

  async function ensureClient() {
    if (client || connecting) return client;
    connecting = true;
    try {
      client = await Client.connect("PraneshJs/GithubprojectQandA");
      return client;
    } finally {
      connecting = false;
    }
  }

  // Simple GitHub repo URL validation
  function isValidRepoUrl(url) {
    const pattern = /^https?:\/\/(www\.)?github\.com\/[^\/\s]+\/[^\/\s#?]+\/?$/i;
    return pattern.test(url);
  }

  function setRunningState(running, message = "") {
    const runBtn = document.getElementById("runBtn");
    const clearBtn = document.getElementById("clearBtn");
    const copyBtn = document.getElementById("copyBtn");
    const status = document.getElementById("statusText");
    const spin = document.getElementById("spinner");

    runBtn.disabled = running;
    clearBtn.disabled = running;
    copyBtn.disabled = running;

    if (running) {
      spin.style.display = "inline-block";
      status.textContent = message || "Processing…";
    } else {
      spin.style.display = "none";
      status.textContent = message || "";
    }
  }

  function saveState() {
    try {
      const url = document.getElementById("repoUrl").value.trim();
      const topic = document.getElementById("topic").value.trim();
      const n = document.getElementById("numQ").value;
      localStorage.setItem("ghqa:url", url);
      localStorage.setItem("ghqa:topic", topic);
      localStorage.setItem("ghqa:n", n);
    } catch {}
  }

  function restoreState() {
    try {
      const url = localStorage.getItem("ghqa:url");
      const topic = localStorage.getItem("ghqa:topic");
      const n = localStorage.getItem("ghqa:n");

      if (url) document.getElementById("repoUrl").value = url;
      if (topic) document.getElementById("topic").value = topic;
      if (n) {
        document.getElementById("numQ").value = n;
        document.getElementById("qval").textContent = n;
      }
    } catch {}
  }

  // Render only Q&A section, color Q and A differently
  function renderQAColored(qaText) {
    let qaSection = qaText;
    // Remove everything before Q&A: (case-insensitive)
    const idx = qaSection.search(/Q&A:/i);
    if (idx !== -1) qaSection = qaSection.slice(idx + 4);
    qaSection = qaSection.trim();
    // Color Q and A lines
    return qaSection.split('\n').map(line => {
      if (/^Q\d*:/.test(line.trim())) {
        return `<span class="qa-q">${line}</span>`;
      } else if (/^A\d*:/.test(line.trim())) {
        return `<span class="qa-a">${line}</span>`;
      } else {
        return line;
      }
    }).join('<br>');
  }

  async function runAnalysis() {
    const urlEl = document.getElementById("repoUrl");
    const topicEl = document.getElementById("topic");
    const nEl = document.getElementById("numQ");
    const outEl = document.getElementById("output");
    const status = document.getElementById("statusText");
    const errEl = document.getElementById("errorMsg");

    const url = urlEl.value.trim();
    const topic = topicEl.value.trim();
    const n = Number(nEl.value);

    errEl.textContent = "";
    outEl.textContent = "";

    if (!url) {
      errEl.textContent = "Please enter a GitHub repository URL (required).";
      urlEl.focus();
      return;
    }
    if (!isValidRepoUrl(url)) {
      errEl.textContent = "Please enter a valid GitHub repo URL like https://github.com/owner/repo";
      urlEl.focus();
      return;
    }

    saveState();
    setRunningState(true, "Connecting…");
    outEl.setAttribute("aria-busy", "true");

    try {
      const cli = await ensureClient();
      setRunningState(true, "Analyzing repository…");
      await cli.predict("/on_analyze", { url });

      setRunningState(true, "Generating Q&A…");
      const qa = await cli.predict("/on_generate", { n });

      // Only show Q&A section, colored
      const qaContent = (qa?.data?.[0] ?? "");
      outEl.innerHTML = renderQAColored(qaContent);
      status.textContent = "Done";

    } catch (err) {
      document.getElementById("errorMsg").textContent = "Error: " + (err?.message || err);
    } finally {
      setRunningState(false);
      outEl.setAttribute("aria-busy", "false");
    }
  }

  function clearAll() {
    document.getElementById("output").textContent = "";
    document.getElementById("errorMsg").textContent = "";
    document.getElementById("statusText").textContent = "";
    document.getElementById("repoUrl").focus();
  }

  async function copyOutput() {
    const outEl = document.getElementById("output");
    const text = outEl.textContent.trim();
    if (!text) return;
    try {
      await navigator.clipboard.writeText(text);
      const status = document.getElementById("statusText");
      status.textContent = "Copied to clipboard";
      setTimeout(() => {
        if (status.textContent === "Copied to clipboard") status.textContent = "";
      }, 1200);
    } catch {}
  }

  // Keyboard and UI setup
  window.addEventListener("DOMContentLoaded", () => {
    restoreState();
    // Range value bubble
    const range = document.getElementById("numQ");
    const qval = document.getElementById("qval");
    range.addEventListener("input", () => { qval.textContent = range.value; });

    // Enter submits from text inputs
    const formInputs = [document.getElementById("repoUrl"), document.getElementById("topic")];
    formInputs.forEach(el => el.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        runAnalysis();
      }
    }));

    // Buttons
    document.getElementById("runBtn").addEventListener("click", runAnalysis);
    document.getElementById("clearBtn").addEventListener("click", clearAll);
    document.getElementById("copyBtn").addEventListener("click", copyOutput);
  });
</script>
</head>
<body>
  <div class="container">
    <header>
      <h1 class="title text-balance">GitHub Project Q&amp;A</h1>
      <p class="subtitle">Analyze a GitHub repository, optionally focus on a topic, and generate Q&amp;A — works on any device.</p>
    </header>

    <main>
      <section class="card" aria-labelledby="form-title">
        <h2 id="form-title" class="sr-only">Repository Settings</h2>
        <div class="grid grid-2">
          <div class="field">
            <label for="repoUrl">GitHub Repo URL <span class="sr-only">(required)</span></label>
            <input id="repoUrl" type="text" inputmode="url" autocomplete="url" placeholder="https://github.com/owner/repo" aria-required="true" />
            <div class="hint">Example: https://github.com/vercel/next.js</div>
          </div>

          <div class="field">
            <label for="topic">Optional Focus Topic</label>
            <input id="topic" type="text" placeholder="e.g., auth, DB, CI/CD" />
            <div class="hint">If provided, we’ll fetch additional insights for this topic.</div>
          </div>

          <div class="field">
            <label for="numQ">Number of Q&amp;A</label>
            <div class="range-row">
              <input id="numQ" type="range" min="1" max="20" value="5" aria-describedby="qdesc" />
              <div class="range-val" aria-live="polite" aria-atomic="true" id="qval">5</div>
            </div>
            <div id="qdesc" class="hint">Choose how many questions and answers to generate.</div>
          </div>

          <div class="field">
            <label class="sr-only">Actions</label>
            <div class="actions">
              <button id="runBtn" type="button" title="Run Analysis">Run Analysis</button>
              <button id="copyBtn" type="button" class="btn-secondary" title="Copy output">Copy Output</button>
              <button id="clearBtn" type="button" class="btn-secondary" title="Clear output">Clear</button>
            </div>
            <div class="status" aria-live="polite" aria-atomic="true">
              <span id="spinner" class="spinner" style="display:none" aria-hidden="true"></span>
              <span id="statusText"></span>
            </div>
            <div id="errorMsg" class="error" role="alert" aria-live="assertive"></div>
          </div>
        </div>

        <div class="output-wrap">
          <label for="output">Output</label>
          <pre id="output" class="output-area" role="status" aria-live="polite" aria-atomic="false" aria-busy="false"></pre>
        </div>
      </section>

      <footer>
        Tip: Press Enter while focused in a text field to run analysis. Your last inputs are saved locally.
      </footer>
    </main>
  </div>
</body>
</html>